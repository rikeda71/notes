# 9章 コードレビュー

```markdown
要約: Google で実践されているコードレビューのプロセスについて紹介

- レビューの観点を分けること（改修箇所、コードベースからみた妥当性、プログラミング言語から見たリーダビリティ）
- 小さな変更を書くこと（200行以内の改修をレビューに出すことで、レビュワーが1人で事足り、レビューサイクルが円滑になる）
- プロフェッショナルの意識、尊敬の意識を忘れない。レビュワー、レビュイーを尊重すべき
```

## コードレビューのフロー

- 作者が変更に満足したら1人以上のレビュワーにレビュー依頼を出す
- レビュワーはコードレビューツール上で変更を確認する
- 修正のサイクルを回し、問題なくなったらレビュワーから LGTM を出す
- デフォルトで必要なのは LGTM 1つのみ

## Google におけるコードレビュー

### 承認を要求するレビューの種類

いずれも別の人物に確認してもらう必要はない。同じ1人に全てを確認してもらうことで、開発サイクルが早まる。

- 挙動のチェック
- コードベースからみた正しさ（コードベースのオーナーたち1名以上）
- 言語特有の制約やリーダビリティ（プログラミング言語ごとの資格の保有者たち1名以上）

後者2つは自身もレビュワーに含んで良い。
そのため、コードベースのオーナーであれば、早く開発サイクルを回せる。
オーナーに何人定めるかはチーム次第。

- 実務では、2個以上承認をようするコードレビューのほとんどは、2段階のプロセスを通る。
  - ピアのエンジニアからのLGTM（これは必須）
  - コードベースのオーナー、リーダビリティのレビュワー
- 3つの役割に分けることで、自身のレビュー担当領域に集中できる

## コードレビューの恩恵

コードレビューは「義務」で、Googleの全てのソフトウェアエンジニアが参加必須の数少ない全社的プロセスの1つ。
ほぼ全てのコード変更に対して、レビューを要求する文化になっている

### コードの正しさ

- 客観的にコードを見ることでバイアスを取り除く
- コードの正しさの評価が主観的になることを防ぐため、**代替案があったとしても、それがパフォーマンス、リーダビリティ的に優れていない場合は、コードを書いた人の意見が尊重される**

### コードの意味の把握

- 他人からコードを見ることで、コードの可読性がわかる
- **LGTM はコードが期待通り動くだけでなく、意味が理解できることも含めた上で出す**

### コードの一貫性

- 言語ごとのベストプラクティスとして合意が取れているものに従っていること

### 心理的・文化的な恩恵

- コードを「自分個人のもの」ではなく、集合的な事業の一部であるという認識を強化させる
- レビュープロセスは**批判的な意見を要求するもの**
  - 批判をすることになるが、それは職務を全うすることになるので、個人を責めたわけではないという前提が作れる

### 知識共有

- レビュワー、レビュイー双方に知識が共有される機会を創出する

## コードレビューのベストプラクティス

### 礼儀正しくプロフェッショナルに

- Google では信頼と尊敬の文化を重要視している
- 作者のアプローチに**不十分な箇所があれば代案の指摘をする。それ以外は基本的に作者を尊重すべき**
  - そのアプローチが取られた理由を考える。質問する
- **営業時間にして、24時間以内に初回のフィードバックをすべき**
- 少しずつ断片的にコメントしない。レビュイー的に修正が完了したと思っていたところにコメントが来ると、心理的安全性が損なわれる

### 小さな変更を書け

- **200行までのコード**
- Googleでの大半の変更は1日以内にレビューされることが期待される。つまり、レビューのコストが大きい変更はNG
  - Googleでのコード変更の35%は1ファイルに対するのみの変更
- **この前提があることで、レビュワーが通常1人ですむ**

### レビュアーの人数は最小限にとどめる

- **最も重要なLGTMは初回のLGTM**
- レビュープロセスをスケールさせるためにも極力必要最低限の人数にレビューを依頼

## コードレビューの類型

### グリーンフィールドコードレビュー

- 完全に新しいコードのレビュー。レビュー範囲も広い
- チェック項目
  - API設計
  - ユニットテストの完全性
  - 十分なコメント、ドキュメンテーション

### 挙動の変更・改善・最適化

### バグ修正・ロールバック

- **バグ修正以外の問題にも対処する誘惑を避ける**
- ロールバックにもレビューが必要

### リファクタリング・大規模変更

- 自動生成のコードも当てはまる
  - Google では、自動生成のコードもレビューする
