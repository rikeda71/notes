# 11章 テスト概観

```markdown
要約: Googleでのテストの種類、分類、割合
テスト文化を普及させた方法

- テストスイートの設計（STest, MTest, LTest, 影響範囲）
- Google規模でのテスト（実行速度を早く、テストコードもプロダクションコードと同様に管理）
```

## なぜテストを書くのか

- Google では、テストは後からの付け足しであってはならない
⇒ 機能を実装するときに必ずテストも追加しなければならない。後からテストを追加するといったタスクを実施すべきではない

## Google でテスト文化が栄えた理由

- 初期はエンジニア主導のテストは重要でないと言われていた
- Google 検索のサーバーについて、ソフトウェアテストを導入することで、半年くらい経った後に以前より工数が短くなったという成功体験から、社内でテストを記述する文化が栄えた
- ↑より、現代的なシステム開発の速度・スケールに遅れずについていく唯一の方法として、エンジニア全員によるテスト開発の共有に頼ることが挙げ得られている

- さらに、新入社員にテストの研修・オリエンテーションを実施し、新入社員からテストの文化を現場に普及させるような仕組みになっている

### テスト認定プログラム

- level 1 ~ 5 を策定
- level1 は CI で実行、コードカバレッジを追跡、前テストの S, M, L Test への分類、素早く実行できるテストにする、などがある
- level が上がると、テストが破綻している状態でのリリースがない、非決定的なテストがなくなる、などの条件を追加
- これを社内ダッシュボードで全エンジニアにプロダクトごとに公開、競い合うことで、テストの品質が上がった

### トイレでのテスト

- トイレにテストのtipsを掲載

### pH ツール

- テストカバレッジ、テストレイテンシーを含むプロジェクトの健全性についてのメトリクスを継続的に監視
- プロダクトごとに表示

## コードをテストする利点

以下の観点が担保されることによる生産性向上

- デバッグの減少
- 変更への信頼の増大
- ドキュメンテーションの改善
    - テストが実質的にメンテナンスされるドキュメントに該当
- レビューの単純化
    - 手元でデバッグすることでなく、コードのロジックとテストの網羅性をレビューでチェックすれば良いことになっている
- 思慮に富む設計
    - テストを書くことで、関数設計が優れているかについても検証できる
- 高速・高品質なリリース

## テストスイート設計・テスト規模

Google では Unit Test, integration test というふうにテストを分けず、テストをその規模で分類している（大中小）これは「テスト範囲とは無関係に速度と決定性をテストスイートに望む特性としているから」
⇒ 業務系でやっている STest, MTest, LTest はこれを真似ている

Google ではこうなっているが、チームや組織ごとに粒度は検討すべき

- STest
    - 単一のプロセス内で実行
    - 最も書くべきテスト
    - （ほとんどのプログラミング言語では、テストはシングルスレッド内で実行されなければならないと指定）
        - テストコードがテストされるコードと同じプロセス内で実行されなければならない
    - 以下の制約をかし、実行速度を高める
        - sleepがだめ、I/O操作ができない
        - ネットワーク・ディスクアクセスが許可されていない
- MTest
    - 単一のマシン上で実行
    - スレッドを使ってOK
    - [localhost](http://localhost) 内のネットワーク呼び出しOK
    - 単一のマシン内で処理が収まっている必要がある
- LTest
    - 任意の箇所で実行
    - localhost外のネットワーク呼び出しOK
    - システム全体の設定の検証用であり、コードの正しさを担保するモノではない
    - レガシーコンポーネントのテストに使われることもある

### 全テスト共通の制約

- 共通リソース（DBなど）に依存すべきではない
    - 最低限、分離独立した状態を保証するための努力をすべき
    - 例えば、利用するデータがテストごとに違うことが保証されるなど
        - budget-service はこの方針
- テスト内で条件分岐・ループのような制御フロー文を利用することは強く非推奨
    - テスト自体にバグを含むリスクがある
    - これは結構やりがちなので気をつけたい

### テスト範囲

- テスト規模の他に「あるテストでどれだけの量のコードが検証されるか」という指標の「テスト範囲」にも気をつけている
- できるだけテスト規模・テスト範囲が小さくなるテストが多くなるようにしたい
- func test、e2eテストは大規模になりがち
- Google では mock を使うのをできるだけ避けたがる

理想的なテスト比率はピラミッド構造

理想的でないテスト構造は砂時計型やアイスクリーム型に近いかも
（unit > e2e(func) > integration test の順になっているものなど）

### code coverage について

- コードカバレッジを計測するのはいいが、目標にしない
（結構やりがち）
- テストいないコードへの知見を与えるが、システムが適切にテストされているかについて考えるためにはならない

## Google 規模でのテスト

- **Google ではほとんどのプロダクトコードが単一のモノレポで管理**
    - エンジニアにコードベースに対する責任を持たせる
    - 他のプロダクトのコードを参照できることによる利点もある
- さらに、コミットはリポジトリのヘッドに対して実行され、直ちにエンジニア全員に見えるようになる（ブランチを切らない）
- このような構成から、**遅いテストや脆いテスト（主にモックを誤って使ったテストで発生する）を定期的にリファクタ・プロダクションコードと同等に責任を持って管理する必要がある**
